<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì¹´í˜ ìŠ¤íƒœí”„</title>
<style>
body { font-family: sans-serif; padding: 20px; }
.box { border-bottom: 1px solid #ccc; margin-bottom: 12px; padding-bottom: 8px; }
.done { color: gray; text-decoration: line-through; }
.service { background: #e8f4ff; padding: 8px; border-radius: 6px; margin: 6px 0; }
button { margin: 2px; }
</style>
</head>
<body>

<h2>ğŸ”Š ì•Œë¦¼</h2>
<button onclick="enableSound()">ì•Œë¦¼ ì¼œê¸°</button>

<h2>ğŸ“‹ ì£¼ë¬¸</h2>
<div id="orders"></div>

<h2>ğŸ”” ì„œë¹„ìŠ¤ ìš”ì²­</h2>
<div id="services"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ===================== Firebase ì´ˆê¸°í™” ===================== */
firebase.initializeApp({
  apiKey: "AIzaSyCjrPv7idDtgkNtaQNQn9RJY4FNDVl_QZ0",
  databaseURL: "https://cafe-complain-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db = firebase.database();

/* ===================== ì•Œë¦¼ ì†Œë¦¬ ===================== */
let audioCtx;

function enableSound() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  playAlert();
  alert("ì•Œë¦¼ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤");
}

function playAlert() {
  if (!audioCtx) return;

  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();

  osc.type = "sine";
  osc.frequency.value = 1000;
  gain.gain.value = 0.18;

  osc.connect(gain);
  gain.connect(audioCtx.destination);

  osc.start();
  osc.stop(audioCtx.currentTime + 0.2);
}

/* ===================== ì£¼ë¬¸ í‘œì‹œ ===================== */
db.ref("orders").on("value", snap => {
  const ordersDiv = document.getElementById("orders");
  ordersDiv.innerHTML = "";

  snap.forEach(c => {
    const key = c.key;
    const d = c.val();

    ordersDiv.innerHTML += `
      <div class="box ${d.done ? 'done' : ''}">
        <b>í…Œì´ë¸” ${d.table}</b><br>
        ${d.items.map(i => `${i.name} x${i.qty}`).join("<br>")}
        <br><b>í•©ê³„ ${d.total}ì›</b>

        ${d.note ? `<div class="service">ğŸ“ ìš”ì²­ì‚¬í•­: ${d.note}</div>` : ""}

        <button onclick="deleteOrder('${key}')">ì‚­ì œ</button>
      </div>
    `;
  });
});

/* ===================== ì„œë¹„ìŠ¤ ìš”ì²­ í‘œì‹œ ===================== */
db.ref("serviceRequests").on("value", snap => {
  const servicesDiv = document.getElementById("services");
  servicesDiv.innerHTML = "";

  snap.forEach(c => {
    const d = c.val();

    servicesDiv.innerHTML = `
      <div class="service">
        <b>í…Œì´ë¸” ${d.table}</b> - ${d.message}
        <button onclick="completeService('${c.key}')">ì™„ë£Œ</button>
      </div>
    ` + servicesDiv.innerHTML;
  });
});

/* ===================== ì‚­ì œ / ì™„ë£Œ ===================== */
function deleteOrder(key) {
  if (confirm("ì´ ì£¼ë¬¸ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
    db.ref("orders/" + key).remove();
  }
}

function completeService(key) {
  if (confirm("ì´ ìš”ì²­ì„ ì™„ë£Œ ì²˜ë¦¬í•˜ê³  ì‚­ì œí• ê¹Œìš”?")) {
    db.ref("serviceRequests/" + key).remove();
  }
}

/* ===================== ìƒˆ ì£¼ë¬¸ / ìš”ì²­ ì•Œë¦¼ ===================== */
let initOrders = true;
let initService = true;

db.ref("orders").on("child_added", () => {
  if (!initOrders) playAlert();
});
db.ref("orders").once("value", () => initOrders = false);

db.ref("serviceRequests").on("child_added", () => {
  if (!initService) playAlert();
});
db.ref("serviceRequests").once("value", () => initService = false);
</script>

</body>
</html>

